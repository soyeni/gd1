<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Babylon.js Village</title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.js"></script>
    <script src="https://cdn.babylonjs.com/serializers/babylon.glTFSerializer.js"></script>
</head>
<body>
    <canvas id="renderCanvas" style="width: 100%; height: 100%;"></canvas>
    <button id="downloadButton" style="position: absolute; top: 20px; left: 20px; z-index: 10;">Download Scene</button>
    
    <script>
        var canvas = document.getElementById("renderCanvas");
        var engine = new BABYLON.Engine(canvas, true);

        const createScene = function () {
            const scene = new BABYLON.Scene(engine);

            // Camera and Light setup
            const camera = new BABYLON.ArcRotateCamera("camera", -Math.PI / 2, Math.PI / 2.5, 15, new BABYLON.Vector3(0, 0, 0), scene);
            camera.attachControl(canvas, true);
            
            const directionalLight = new BABYLON.DirectionalLight("sunLight", new BABYLON.Vector3(-1, -1, 0), scene);
            directionalLight.intensity = 0.5;

            // Skybox
            const skybox = BABYLON.MeshBuilder.CreateBox("skyBox", { size: 1000.0 }, scene);
            const skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("textures/skybox", scene);
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skybox.material = skyboxMaterial;

            // Village model
            BABYLON.SceneLoader.ImportMeshAsync("", "https://assets.babylonjs.com/meshes/", "village.glb");

            // Sun Sphere with particle effect
            const sun = BABYLON.MeshBuilder.CreateSphere("sun", { diameter: 1.5 }, scene);
            sun.position = new BABYLON.Vector3(0, 8, 0);
            const sunMaterial = new BABYLON.StandardMaterial("sunMaterial", scene);
            sunMaterial.emissiveTexture = new BABYLON.Texture("https://www.solarsystemscope.com/textures/download/8k_sun.jpg", scene);
            sun.material = sunMaterial;

            // Day-night cycle
            let dayTime = 0;
            scene.registerBeforeRender(() => {
                dayTime += 0.005;
                directionalLight.direction = new BABYLON.Vector3(Math.sin(dayTime), -1, Math.cos(dayTime));
                directionalLight.intensity = Math.max(0.1, Math.sin(dayTime) * 0.5 + 0.5);
            });

            // Function to create orbiting planets with trails
            function createOrbitingPlanet(radius, textureURL, orbitDistance, speed) {
                const pivot = new BABYLON.TransformNode("pivot", scene);
                pivot.position = sun.position;

                const planet = BABYLON.MeshBuilder.CreateSphere("planet", { diameter: radius }, scene);
                planet.position.x = orbitDistance;
                planet.parent = pivot;
                
                const planetMaterial = new BABYLON.StandardMaterial("planetMaterial", scene);
                planetMaterial.diffuseTexture = new BABYLON.Texture(textureURL, scene);
                planet.material = planetMaterial;

                // Trail effect
                const trail = new BABYLON.TrailMesh("trail", planet, scene, 0.1, 30, true);
                trail.material = new BABYLON.StandardMaterial("trailMaterial", scene);
                trail.material.emissiveColor = new BABYLON.Color3(Math.random(), Math.random(), Math.random());

                scene.registerBeforeRender(() => {
                    pivot.rotation.y += speed;
                });
            }

            // Planets with trails
            createOrbitingPlanet(0.5, "https://smd-cms.nasa.gov/wp-content/uploads/2023/09/PIA17386.jpg", 3, 0.01);
            createOrbitingPlanet(0.7, "https://planetpixelemporium.com/download/download.php?venusmap.jpg", 5, 0.008);
            createOrbitingPlanet(1, "https://planet-texture-maps.fandom.com/wiki/Special:FilePath/Earth_Texture_Full.png", 7, 0.005);

            return scene;
        };

        const scene = createScene();
        engine.runRenderLoop(() => scene.render());
        window.addEventListener("resize", () => engine.resize());

        function exportToGLB() {
            BABYLON.GLTF2Export.GLBAsync(scene, "enhanced_scene.glb").then((glb) => {
                glb.downloadFiles();
            });
        }

        document.getElementById("downloadButton").addEventListener("click", exportToGLB);
    </script>
</body>
</html>
